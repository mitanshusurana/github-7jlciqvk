import{k as N,r as i,V as y}from"./index-CckSQYX7.js";import{p as m}from"./productService-JC5t_XUH.js";const j=o=>({id:Math.floor(Math.random()*1e6),title:o.name,body_html:o.description,vendor:o.supplier,product_type:o.productType,variants:[{price:o.price,sku:o.id,inventory_quantity:o.productType==="LooseStone"?o.quantity:1}]}),M={async createProduct(o){return console.log("Creating product on Shopify:",o),Promise.resolve({id:j(o).id})},async updateProduct(o,l){return console.log(`Updating product ${o} on Shopify:`,l),Promise.resolve()},async deleteProduct(o){return console.log(`Deleting product ${o} from Shopify`),Promise.resolve()}},x=N(o=>({productCache:{},singleProductCache:{},setProductCache:(l,f)=>o(d=>({productCache:{...d.productCache,[l]:f}})),setSingleProductCache:(l,f)=>o(d=>({singleProductCache:{...d.singleProductCache,[l]:f}})),clearCaches:()=>o(()=>({productCache:{},singleProductCache:{}}))})),z=400,Q=()=>{const[o,l]=i.useState({content:[],totalPages:0,totalElements:0,size:0,number:0}),[f,d]=i.useState(!0),[q,k]=i.useState(null),[n,F]=i.useState({page:1,limit:12}),[P,L]=i.useState({totalItems:0,totalPages:0}),[c,G]=i.useState({}),g=i.useRef(null),{productCache:C,singleProductCache:h,setProductCache:b,setSingleProductCache:v,clearCaches:A}=x(),E=JSON.stringify(c),w=i.useCallback(()=>JSON.stringify({page:n.page,limit:n.limit,...c}),[n.page,n.limit,E]),u=i.useCallback(async()=>{d(!0),k(null);const r=w(),t=C[r];if(t){l(t),d(!1);return}try{let e=(await m.getProducts()).content||[];c.search&&(e=e.filter(a=>a.name.toLowerCase().includes(c.search.toLowerCase()))),c.category&&(e=e.filter(a=>a.productType==="Jewelry"&&a.category===c.category)),c.style&&(e=e.filter(a=>a.productType==="Jewelry"&&a.style===c.style)),c.metal&&(e=e.filter(a=>a.productType==="Jewelry"&&a.metal===c.metal)),c.clarityGrade&&(e=e.filter(a=>a.productType==="LooseStone"&&a.clarityGrade===c.clarityGrade)),c.rarity&&(e=e.filter(a=>a.productType==="CarvedIdol"&&a.rarity===c.rarity)),c.workmanshipGrade&&(e=e.filter(a=>a.productType==="CarvedIdol"&&a.workmanshipGrade===c.workmanshipGrade)),c.dateFrom&&(e=e.filter(a=>new Date(a.acquisitionDate)>=new Date(c.dateFrom))),c.dateTo&&(e=e.filter(a=>new Date(a.acquisitionDate)<=new Date(c.dateTo)));const p=e.length,I=Math.ceil(p/n.limit),D={content:e.slice((n.page-1)*n.limit,n.page*n.limit),totalPages:I,totalElements:p,size:n.limit,number:n.page};b(r,D),l(D),L({totalItems:p,totalPages:I})}catch(s){const e=s instanceof Error?s.message:"Failed to fetch products";k(e),y.error(e)}finally{d(!1)}},[w,n.page,n.limit,E,b,c]);i.useEffect(()=>{const r=w(),t=C[r];if(t){l(t),d(!1);return}return g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{u()},z),()=>{g.current&&clearTimeout(g.current)}},[w]);const S=()=>{Object.keys(C).forEach(r=>delete C[r])},J=i.useCallback(async r=>{if(h[r])return h[r];try{const t=await m.getProduct(r);return t&&v(r,t),t}catch{y.error("Failed to fetch product details");return}},[h,v]),T=()=>{Object.keys(h).forEach(r=>delete h[r])},O=i.useCallback(async r=>{try{const t=await m.createProduct(r);return await M.createProduct(t),S(),T(),u(),t}catch(t){const s=t instanceof Error?t.message:"Failed to add product";throw y.error(s),t}},[u]),$=i.useCallback(async(r,t)=>{var s;try{const e=await m.updateProduct(r,t);(s=e.platformIds)!=null&&s.shopifyId&&await M.updateProduct(parseInt(e.platformIds.shopifyId),e);const p=e.productType==="LooseStone"?e.quantity:e.inventoryQuantity;return p!==void 0&&e.reorderThreshold!==void 0&&p<e.reorderThreshold&&(console.log(`Reorder request for product ${e.name} (ID: ${e.id})`),y.info(`Reorder request for product ${e.name}`)),S(),T(),u(),e}catch(e){throw y.error("Failed to update product"),e}},[u]),K=i.useCallback(async r=>{try{return await m.deleteProduct(r),S(),T(),u(),!0}catch{return y.error("Failed to delete product"),!1}},[u]),R=i.useCallback(()=>{n.page<P.totalPages&&F(r=>({...r,page:r.page+1}))},[n.page,P.totalPages]),_=i.useCallback(()=>{const r=o.content||[],t=new Set;return r.forEach(s=>{s.productType==="Jewelry"&&s.category?t.add(s.category):s.productType==="LooseStone"&&s.gemstoneType?t.add(s.gemstoneType):s.productType==="CarvedIdol"&&s.material&&t.add(s.material)}),Array.from(t).sort()},[o.content]);return{products:o,loading:f,error:q,pagination:{...n,...P},hasMore:n.page<P.totalPages,loadMore:R,filters:c,setFilters:G,addProduct:O,updateProduct:$,deleteProduct:K,getProduct:J,getCategories:_,refresh:u}};export{M as s,Q as u};
